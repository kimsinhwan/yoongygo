<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>위치 실시간 지도</title>
<!-- Mapbox CSS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<style>
  #map { width: 100%; height: 500px; position: relative; }
  #miniMap {
    position: absolute;
    bottom: 10px;
    right: 10px;
    width: 150px;
    height: 150px;
    border: 2px solid #ccc;
    border-radius: 4px;
    overflow: hidden;
    z-index: 1;
  }
  #coords, #speed, #heading { margin-top: 10px; }
</style>
</head>
<body>

<div id="map"></div>
<!-- 미니맵 컨테이너 -->
<div id="miniMap"></div>

<div id="status"></div>
<div id="coords">위도: - / 경도: -</div>
<div id="speed">속도: -</div>
<div id="heading">방향: -</div>

<!-- Mapbox JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script>
  // Mapbox 액세스 토큰
  mapboxgl.accessToken = 'pk.eyJ1IjoieW9vbmd5OTEiLCJhIjoiY21jMDczMzV1MXg0YTJqbjFiazMzdWI0ciJ9.1553HcxLbM-BN_v6t5d3zg';

  // 메인 지도 초기화
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [126.9780, 37.5665], // 서울
    zoom: 15,
    pitch: 0,
    bearing: 0,
    interactive: false
  });

  // 미니맵 초기화
  const miniMap = new mapboxgl.Map({
    container: 'miniMap',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [126.9780, 37.5665],
    zoom: 12,
    interactive: false
  });

  // 커스텀 마커 생성
  const markerEl = document.createElement('div');
  markerEl.style.backgroundImage = 'url(marker_small.png)'; // 이미지 경로 수정 필요
  markerEl.style.width = '32px';
  markerEl.style.height = '38px';
  markerEl.style.backgroundSize = 'cover';
  markerEl.style.borderRadius = '10px';

  const marker = new mapboxgl.Marker({ element: markerEl })
    .setLngLat([126.9780, 37.5665])
    .addTo(map);

  // 위치 업데이트 시 미니맵도 함께 업데이트
  function updateMaps(lng, lat) {
    const coords = [lng, lat];
    marker.setLngLat(coords);
    map.flyTo({ center: coords, speed: 1.2, curve: 1 });
    miniMap.flyTo({ center: coords, speed: 1.2, curve: 1 });
  }

  // WebSocket 연결
  const socket = new WebSocket('ws://192.168.219.108:8080'); // 서버 주소로 변경

  socket.onopen = () => {
    document.getElementById('status').textContent = 'WebSocket 연결됨';
    startLocationUpdates(); // 위치 업데이트 시작
  };

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    const { latitude, longitude, speed, heading } = data;
    updateMaps(longitude, latitude);

    // 위치 정보 표시 업데이트
    document.getElementById('coords').textContent = `위도: ${latitude.toFixed(5)} / 경도: ${longitude.toFixed(5)}`;
    document.getElementById('speed').textContent = `속도: ${speed ? (speed * 3.6).toFixed(1) + ' km/h' : '-'}`;
    if (heading !== undefined) {
      document.getElementById('heading').textContent = `방향: ${heading.toFixed(0)}°`;
    }
  };

  socket.onerror = (error) => {
    document.getElementById('status').textContent = 'WebSocket 오류 발생';
    console.error('WebSocket Error:', error);
  };

  // 위치 계속 업데이트하는 함수
  let locationIntervalId = null;
  function startLocationUpdates() {
    if (locationIntervalId) return; // 중복 시작 방지
    locationIntervalId = setInterval(() => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          const data = {
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude,
            speed: pos.coords.speed || 0,
            heading: pos.coords.heading || 0
          };
          // 서버에 위치 전송
          socket.send(JSON.stringify(data));
        }, (err) => {
          console.error('위치 정보 가져오기 실패:', err);
        });
      }
    }, 5000); // 5초마다 위치 전송
  }
</script>
</body>
</html>