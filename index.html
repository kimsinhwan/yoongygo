<script>
  // Mapbox 액세스 토큰 (본인 토큰으로 교체하세요)
  mapboxgl.accessToken = 'pk.eyJ1IjoieW9vbmd5OTEiLCJhIjoiY21jMDczMzV1MXg0YTJqbjFiazMzdWI0ciJ9.1553HcxLbM-BN_v6t5d3zg';

  // 지도 초기화
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [126.9780, 37.5665], // 초기 위치 (서울)
    zoom: 15,
    pitch: 0,
    bearing: 0,
    interactive: false
  });

  // 커스텀 마커 생성
  const markerEl = document.createElement('div');
  markerEl.style.backgroundImage = 'url(marker_small.png)'; // 이미지 경로 수정 필요
  markerEl.style.width = '32px';
  markerEl.style.height = '38px';
  markerEl.style.backgroundSize = 'cover';
  markerEl.style.borderRadius = '10px';

  const marker = new mapboxgl.Marker({ element: markerEl })
    .setLngLat([126.9780, 37.5665])
    .addTo(map);

  // WebSocket 연결
  const socket = new WebSocket('ws://192.168.219.108:8080'); // 서버 주소로 변경

  socket.onopen = () => {
    console.log('WebSocket 연결됨');

    // 위치 정보 주기적으로 보내기
    setInterval(() => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const data = {
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude,
            speed: pos.coords.speed || 0,
            heading: pos.coords.heading || 0
          };
          socket.send(JSON.stringify(data));
          // 내 위치를 지도와 마커에 반영
          const coords = [data.longitude, data.latitude];
          marker.setLngLat(coords);
          map.flyTo({ center: coords, speed: 1.2, curve: 1 });
        });
      }
    }, 5000);
  };

  // 서버에서 위치 데이터 수신
  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    const { latitude, longitude, speed, heading } = data;
    const coords = [longitude, latitude];

    // 지도와 마커 업데이트
    marker.setLngLat(coords);
    map.flyTo({ center: coords, speed: 1.2, curve: 1 });

    // 위치 정보 표시 업데이트
    document.getElementById('coords').textContent = `위도: ${latitude.toFixed(5)} / 경도: ${longitude.toFixed(5)}`;
    document.getElementById('speed').textContent = `속도: ${speed ? (speed * 3.6).toFixed(1) + ' km/h' : '-'}`;
    if (heading !== undefined) {
      document.getElementById('heading').textContent = `방향: ${heading.toFixed(0)}°`;
    }
  };

  // 위치 권한 요청 및 최초 위치 갱신
  function requestLocationPermission() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          // 위치 권한 허용 시 위치 업데이트
          const lng = position.coords.longitude;
          const lat = position.coords.latitude;
          const coords = [lng, lat];

          // 내 위치를 지도와 마커에 반영
          marker.setLngLat(coords);
          map.flyTo({ center: coords, zoom: 15, speed: 1.2, curve: 1 });
        },
        (error) => {
          // 권한 거부 또는 오류 처리
          alert('위치 권한이 필요합니다. 권한을 허용해주세요.');
        }
      );
    } else {
      alert('이 브라우저는 위치 정보를 지원하지 않습니다.');
    }
  }

  // 페이지 로드 시 위치 권한 요청
  window.onload = () => {
    requestLocationPermission();

    // 이후 위치 갱신도 계속 수행
    setInterval(() => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const data = {
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude,
            speed: pos.coords.speed || 0,
            heading: pos.coords.heading || 0
          };
          // 서버에 위치 전송
          socket.send(JSON.stringify(data));
          // 지도와 마커 업데이트
          const coords = [data.longitude, data.latitude];
          marker.setLngLat(coords);
          map.flyTo({ center: coords, speed: 1.2, curve: 1 });
        });
      }
    }, 5000);
  };
</script>